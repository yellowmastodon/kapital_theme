<?php
defined('ABSPATH') || exit;
$meta = get_metadata('post', $post->ID, '', true);
$event_date_start = (int)$meta["_event_date_start"][0];

$event_date_end = (int)$meta["_event_date_end"][0];
$event_date_string_object = json_decode($meta["_event_date_string"][0]);
$event_date_string = $event_date_string_object->displayDate;
$event_date_format = $event_date_string_object->format;
$event_locations = kapital_get_event_location_string($meta["_event_location"][0], false);
$post_title = get_the_title();
$secondary_title = $meta["_secondary_title"][0];    
$heading_level = 2;
$timezone = kapital_get_timezone();
$render_settings = kapital_get_render_settings($post->ID, $post->post_type);
$has_location = $render_settings["show_event_location"] && $event_locations !== "" ? true : false;
if (isset($args['post'])){
    $post = $args['post'];
}
if (isset($args['heading_level'])){
    $heading_level = $args['heading_level'];
}

?>
<li class="col-12 col-sm-6 col-md-4 archive-item archive-event-item ff-grotesk lh-sm ">
    <a href="<?= get_the_permalink(); ?>" class="p-3 archive-item-link rounded bg-secondary d-block text-decoration-none">
        <div class="archive-single-event-header item-excerpt row gx-2 flex-nowrap mb-1 lh-1">
            
            <?php if($render_settings["show_date"]):?>
                <div class="col-auto d-none d-sm-block mb-0">
                    <svg class="archive-event-calendar-icon" width="32" height="30" viewBox="0 0 32 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M31 29.8667C31.5523 29.8667 32 29.419 32 28.8667V3.13334C32 2.58106 31.5523 2.13334 31 2.13334H27.6667C27.1144 2.13334 26.6667 1.68563 26.6667 1.13334V1C26.6667 0.447715 26.219 0 25.6667 0H25.5333C24.9811 0 24.5333 0.447715 24.5333 1V1.13334C24.5333 1.68563 24.0856 2.13334 23.5333 2.13334H21.2667C20.7144 2.13334 20.2667 1.68563 20.2667 1.13334V1C20.2667 0.447715 19.819 0 19.2667 0H19.1333C18.581 0 18.1333 0.447715 18.1333 1V1.13334C18.1333 1.68563 17.6856 2.13334 17.1333 2.13334H14.8667C14.3144 2.13334 13.8667 1.68563 13.8667 1.13334V1C13.8667 0.447715 13.419 0 12.8667 0H12.7333C12.181 0 11.7333 0.447715 11.7333 1V1.13334C11.7333 1.68563 11.2856 2.13334 10.7333 2.13334H8.46666C7.91437 2.13334 7.46666 1.68563 7.46666 1.13334V1C7.46666 0.447715 7.01894 0 6.46666 0H6.33333C5.78105 0 5.33333 0.447715 5.33333 1V1.13334C5.33333 1.68563 4.88562 2.13334 4.33333 2.13334H1C0.447716 2.13334 0 2.58106 0 3.13334V28.8667C0 29.419 0.447715 29.8667 1 29.8667H31ZM2.13332 11.6667C2.13332 11.1144 2.58103 10.6667 3.13332 10.6667H28.8667C29.419 10.6667 29.8667 11.1144 29.8667 11.6667V26.7334C29.8667 27.2857 29.419 27.7334 28.8667 27.7334H3.13332C2.58103 27.7334 2.13332 27.2857 2.13332 26.7334V11.6667ZM5.33333 5.26669C5.33333 4.71441 4.88562 4.26669 4.33333 4.26669H3.13332C2.58103 4.26669 2.13332 4.71441 2.13332 5.26669V7.53337C2.13332 8.08565 2.58103 8.53337 3.13332 8.53337H28.8667C29.419 8.53337 29.8667 8.08565 29.8667 7.53337V5.26669C29.8667 4.71441 29.419 4.26669 28.8667 4.26669H27.6667C27.1144 4.26669 26.6667 4.71441 26.6667 5.26669V5.40003C26.6667 5.95232 26.219 6.40003 25.6667 6.40003H25.5333C24.9811 6.40003 24.5333 5.95232 24.5333 5.40003V5.26669C24.5333 4.71441 24.0856 4.26669 23.5333 4.26669H21.2667C20.7144 4.26669 20.2667 4.71441 20.2667 5.26669V5.40003C20.2667 5.95232 19.819 6.40003 19.2667 6.40003H19.1333C18.581 6.40003 18.1333 5.95232 18.1333 5.40003V5.26669C18.1333 4.71441 17.6856 4.26669 17.1333 4.26669H14.8667C14.3144 4.26669 13.8667 4.71441 13.8667 5.26669V5.40003C13.8667 5.95232 13.419 6.40003 12.8667 6.40003H12.7333C12.181 6.40003 11.7333 5.95232 11.7333 5.40003V5.26669C11.7333 4.71441 11.2856 4.26669 10.7333 4.26669H8.46666C7.91437 4.26669 7.46666 4.71441 7.46666 5.26669V5.40003C7.46666 5.95232 7.01894 6.40003 6.46666 6.40003H6.33333C5.78105 6.40003 5.33333 5.95232 5.33333 5.40003V5.26669ZM4.26665 23.5334C4.26665 24.0857 4.71437 24.5334 5.26665 24.5334H5.39998C5.95227 24.5334 6.39998 24.0857 6.39998 23.5334V23.4C6.39998 22.8477 5.95227 22.4 5.39998 22.4H5.26665C4.71437 22.4 4.26665 22.8477 4.26665 23.4V23.5334ZM8.53333 23.5334C8.53333 24.0857 8.98104 24.5334 9.53333 24.5334H9.66667C10.219 24.5334 10.6667 24.0857 10.6667 23.5334V23.4C10.6667 22.8477 10.219 22.4 9.66667 22.4H9.53333C8.98105 22.4 8.53333 22.8477 8.53333 23.4L8.53333 23.5334ZM12.8 23.5334C12.8 24.0857 13.2477 24.5334 13.8 24.5334H13.9333C14.4856 24.5334 14.9333 24.0857 14.9333 23.5334V23.4C14.9333 22.8477 14.4856 22.4 13.9333 22.4H13.8C13.2477 22.4 12.8 22.8477 12.8 23.4V23.5334ZM17.0667 23.5334C17.0667 24.0857 17.5144 24.5334 18.0667 24.5334H18.2C18.7523 24.5334 19.2 24.0857 19.2 23.5334V23.4C19.2 22.8477 18.7523 22.4 18.2 22.4H18.0667C17.5144 22.4 17.0667 22.8477 17.0667 23.4V23.5334ZM4.26665 19.2667C4.26665 19.819 4.71437 20.2667 5.26665 20.2667H5.39998C5.95227 20.2667 6.39998 19.819 6.39998 19.2667V19.1334C6.39998 18.5811 5.95227 18.1334 5.39998 18.1334H5.26665C4.71437 18.1334 4.26665 18.5811 4.26665 19.1334V19.2667ZM8.53333 19.2667C8.53333 19.819 8.98104 20.2667 9.53333 20.2667H9.66667C10.219 20.2667 10.6667 19.819 10.6667 19.2667V19.1334C10.6667 18.5811 10.219 18.1334 9.66667 18.1334H9.53333C8.98105 18.1334 8.53333 18.5811 8.53333 19.1334L8.53333 19.2667ZM12.8 19.2667C12.8 19.819 13.2477 20.2667 13.8 20.2667H13.9333C14.4856 20.2667 14.9333 19.819 14.9333 19.2667V19.1334C14.9333 18.5811 14.4856 18.1334 13.9333 18.1334H13.8C13.2477 18.1334 12.8 18.5811 12.8 19.1334V19.2667ZM17.0667 19.2667C17.0667 19.819 17.5144 20.2667 18.0667 20.2667H18.2C18.7523 20.2667 19.2 19.819 19.2 19.2667V19.1334C19.2 18.5811 18.7523 18.1334 18.2 18.1334H18.0667C17.5144 18.1334 17.0667 18.5811 17.0667 19.1334V19.2667ZM21.3333 19.2667C21.3333 19.819 21.7811 20.2667 22.3333 20.2667H22.4667C23.019 20.2667 23.4667 19.819 23.4667 19.2667V19.1334C23.4667 18.5811 23.019 18.1334 22.4667 18.1334H22.3333C21.781 18.1334 21.3333 18.5811 21.3333 19.1334L21.3333 19.2667ZM25.6 19.2667C25.6 19.819 26.0477 20.2667 26.6 20.2667H26.7333C27.2856 20.2667 27.7334 19.819 27.7334 19.2667V19.1334C27.7334 18.5811 27.2856 18.1334 26.7334 18.1334H26.6C26.0477 18.1334 25.6 18.5811 25.6 19.1334V19.2667ZM4.26665 15C4.26665 15.5523 4.71437 16 5.26665 16H5.39998C5.95227 16 6.39998 15.5523 6.39998 15V14.8667C6.39998 14.3144 5.95227 13.8667 5.39998 13.8667H5.26665C4.71437 13.8667 4.26665 14.3144 4.26665 14.8667V15ZM8.53333 15C8.53333 15.5523 8.98104 16 9.53333 16H9.66667C10.219 16 10.6667 15.5523 10.6667 15V14.8667C10.6667 14.3144 10.219 13.8667 9.66667 13.8667H9.53333C8.98105 13.8667 8.53333 14.3144 8.53333 14.8667L8.53333 15ZM12.8 15C12.8 15.5523 13.2477 16 13.8 16H13.9333C14.4856 16 14.9333 15.5523 14.9333 15V14.8667C14.9333 14.3144 14.4856 13.8667 13.9333 13.8667H13.8C13.2477 13.8667 12.8 14.3144 12.8 14.8667V15ZM17.0667 15C17.0667 15.5523 17.5144 16 18.0667 16H18.2C18.7523 16 19.2 15.5523 19.2 15V14.8667C19.2 14.3144 18.7523 13.8667 18.2 13.8667H18.0667C17.5144 13.8667 17.0667 14.3144 17.0667 14.8667V15ZM21.3333 15C21.3333 15.5523 21.7811 16 22.3333 16H22.4667C23.019 16 23.4667 15.5523 23.4667 15V14.8667C23.4667 14.3144 23.019 13.8667 22.4667 13.8667H22.3333C21.781 13.8667 21.3333 14.3144 21.3333 14.8667L21.3333 15ZM25.6 15C25.6 15.5523 26.0477 16 26.6 16H26.7333C27.2856 16 27.7334 15.5523 27.7334 15V14.8667C27.7334 14.3144 27.2856 13.8667 26.7334 13.8667H26.6C26.0477 13.8667 25.6 14.3144 25.6 14.8667V15Z" fill="currentColor" />
                    </svg>
                </div>
            <?php endif; ?>
            <div class="col mb-0">
                <?php
                if($render_settings["show_date"]):
                    if (isset($args['is_old_event']) && $args['is_old_event']) {
                        $event_header_text = __('archÃ­v', 'kapital');
                    } else {
                        $event_header_text = kapital_event_get_remaining($event_date_start, $event_date_end, kapital_get_timezone(), $event_date_format);
                    } ?>
                    <p class="fw-bold mb-0 text-uppercase"><?= '(' . $event_header_text . ')' ?></p>
                    <?= get_publish_datetime_element_event($event_date_start, $event_date_format, $event_date_string, 'text-uppercase fw-bold d-block mt-1 text-event-gray') ?>
                <?php endif;    
                echo $has_location ? '<p class="d-block d-sm-none mt-1 mb-0">'. $event_locations. '</p>' : ''?>
            </div>
        </div>
        <?php
        $thumbnail_image_id = get_post_thumbnail_id($post->ID);
        if ($thumbnail_image_id) {
            echo kapital_responsive_image(get_post_thumbnail_id($post->ID), "(max-width: 599px) 95vw, (max-width: 899px) 47vw, (max-width: 1199px) 32vw, (max-width: 1399px) 300px, (max-width: 1649px) 260px, 312px", false, 'rounded w-100 archive-item-image');
        } else {
            echo '<div class="rounded w-100 archive-item-image placeholder bg-secondary-light"></div>';
        } ?>
        <?=$has_location ? '<p class="d-none d-sm-block mt-1 mb-3 item-excerpt">'. $event_locations. '</p>' : ''?>
        <<?= 'h' . $heading_level;?> class="mt-1 mb-3 archive-item-heading red-outline-hover" data-text="<?php echo $post_title ?>"><?php echo $post_title ?></<?= 'h' . $heading_level;?>>
        <div class="item-excerpt red-color-hover lh-sm">
            <?php if ($secondary_title !== "") echo '<p>' . $secondary_title . '</p>';
                echo get_the_excerpt($post);
                 ?>
        </div>
    </a>
</li>